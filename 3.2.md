
### 3. KOBIS OPENAPI

영화관 입장권 통합 전산망 OPENAPI를 사용하여 일일 박스오피스 자료를 가져오고 JSON파일로 저장

```python
import os
import requests
import json
import calendar
from tqdm import tqdm
from datetime import date, timedelta

key='ad816991534afeaef71f07e7336b0d61'
movie_info_path='/root/movie/data/'
```

폴더가 존재하는지 확인한 뒤 없으면 생성하는 함수

```python
def check_dir(start_date,end_date):    
    start_year = int(start_date.year)
    end_year = int(end_date.year)
    year = start_year
    for i in tqdm(range(start_year,end_year+1)):        
        if(os.path.isdir(movie_info_path+str(year))!=1):
            os.mkdir(movie_info_path+str(year)+'/')
            print("create "+str(year)+" folder") 
            
        if(os.path.isdir(movie_info_path+str(year)+'_K')!=1):
            os.mkdir(movie_info_path+str(year)+'_K/')
            print("create "+str(year)+"_K folder")   
            
        if(os.path.isdir(movie_info_path+str(year)+'_F')!=1):
            os.mkdir(movie_info_path+str(year)+'_F/')
            print("create "+str(year)+"_F folder")    
        year += 1
```

일일 박스오피스 자료를 찾고 없으면 API를 통해 자료를 받아온다

파일은 JSON 타입으로 해당 폴더에 저장

```python
def daily_box_office_to_json(start_date,end_date):    
    tmp_date = start_date
    startDt = int(str(start_date)[0:4]+str(start_date)[5:7]+str(start_date)[8:10])
    endDt = int(str(end_date)[0:4]+str(end_date)[5:7]+str(end_date)[8:10])
    days = end_date - start_date
    for i in tqdm(range(0,days.days+1)):
        targetDt = int(str(tmp_date)[0:4]+str(tmp_date)[5:7]+str(tmp_date)[8:10])
        
        if(os.path.isfile("/root/movie/data/"+str(targetDt)[0:4]+'/'+str(targetDt)+'.json')!=1):
            url='http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json?key='+key+'&targetDt='+str(targetDt)
            res = requests.get(url)
            text = res.text
            d = json.loads(text)
            with open('data/'+str(targetDt)[0:4]+'/'+str(targetDt)+'.json', 'w', encoding="utf-8") as make_file:
                json.dump(d, make_file, ensure_ascii=False, indent="\t")
                
        if(os.path.isfile("/root/movie/data/"+str(targetDt)[0:4]+'_K/'+str(targetDt)+'_K.json')!=1):
            url='http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json?key='+key+'&targetDt='+str(targetDt)+'&repNationCd=K'
            res = requests.get(url)
            text = res.text
            d = json.loads(text)
            with open('data/'+str(targetDt)[0:4]+'_K/'+str(targetDt)+'_K.json', 'w', encoding="utf-8") as make_file:
                json.dump(d, make_file, ensure_ascii=False, indent="\t")
                
        if(os.path.isfile("/root/movie/data/"+str(targetDt)[0:4]+'_F/'+str(targetDt)+'_F.json')!=1):
            url='http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json?key='+key+'&targetDt='+str(targetDt)+'&repNationCd=F'
            res = requests.get(url)
            text = res.text
            d = json.loads(text)
            with open('data/'+str(targetDt)[0:4]+'_F/'+str(targetDt)+'_F.json', 'w', encoding="utf-8") as make_file:
                json.dump(d, make_file, ensure_ascii=False, indent="\t")

        tmp_date += timedelta(1)
```

샘플 데이터로 2017년 전체 자료를 받아온다

```python
start_date = date(2017,1,1)
end_date = date(2017,12,31)
check_dir(start_date,end_date)
daily_box_office_to_json(start_date,end_date)
```

    100%|██████████| 1/1 [00:00<00:00, 576.85it/s]
    100%|██████████| 365/365 [00:00<00:00, 29090.58it/s]


```python
import pandas as pd
import requests
import datetime
import json
from tqdm import tqdm_notebook
from dateutil.relativedelta import relativedelta

my_date = datetime.date(2017, 1, 1)
```

```python
start_date = date(2017,1,1)
targetDt = str(start_date)[0:4]+str(start_date)[5:7]+str(start_date)[8:10]
with open('data/'+str(targetDt)[0:4]+'/'+str(targetDt)+'.json', 'r', encoding="utf-8") as read_file:
    d = json.load(read_file)
d
```




    {'boxOfficeResult': {'boxofficeType': '일별 박스오피스',
      'showRange': '20170101~20170101',
      'dailyBoxOfficeList': [{'rnum': '1',
        'rank': '1',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20161725',
        'movieNm': '마스터',
        'openDt': '2016-12-21',
        'salesAmt': '4399793100',
        'salesShare': '46.3',
        'salesInten': '-183705150',
        'salesChange': '-4',
        'salesAcc': '44184434165',
        'audiCnt': '506299',
        'audiInten': '-31485',
        'audiChange': '-5.9',
        'audiAcc': '5441619',
        'scrnCnt': '1245',
        'showCnt': '5721'},
       {'rnum': '2',
        'rank': '2',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20163183',
        'movieNm': '로그 원: 스타워즈 스토리',
        'openDt': '2016-12-28',
        'salesAmt': '1612424700',
        'salesShare': '17.0',
        'salesInten': '-351990650',
        'salesChange': '-17.9',
        'salesAcc': '6739961794',
        'audiCnt': '173451',
        'audiInten': '-40093',
        'audiChange': '-18.8',
        'audiAcc': '769938',
        'scrnCnt': '810',
        'showCnt': '3335'},
       {'rnum': '3',
        'rank': '3',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20162025',
        'movieNm': '씽',
        'openDt': '2016-12-21',
        'salesAmt': '943975500',
        'salesShare': '9.9',
        'salesInten': '-118258900',
        'salesChange': '-11.1',
        'salesAcc': '9147833289',
        'audiCnt': '115152',
        'audiInten': '-18516',
        'audiChange': '-13.9',
        'audiAcc': '1178327',
        'scrnCnt': '721',
        'showCnt': '1755'},
       {'rnum': '4',
        'rank': '4',
        'rankInten': '1',
        'rankOldAndNew': 'OLD',
        'movieCd': '20144641',
        'movieNm': '판도라',
        'openDt': '2016-12-07',
        'salesAmt': '736891900',
        'salesShare': '7.7',
        'salesInten': '-35339100',
        'salesChange': '-4.6',
        'salesAcc': '34692290064',
        'audiCnt': '87966',
        'audiInten': '-6799',
        'audiChange': '-7.2',
        'audiAcc': '4401830',
        'scrnCnt': '576',
        'showCnt': '1476'},
       {'rnum': '5',
        'rank': '5',
        'rankInten': '-1',
        'rankOldAndNew': 'OLD',
        'movieCd': '20167904',
        'movieNm': '라라랜드',
        'openDt': '2016-12-07',
        'salesAmt': '770889600',
        'salesShare': '8.1',
        'salesInten': '-162044100',
        'salesChange': '-17.4',
        'salesAcc': '20767028832',
        'audiCnt': '87529',
        'audiInten': '-21007',
        'audiChange': '-19.4',
        'audiAcc': '2472637',
        'scrnCnt': '590',
        'showCnt': '1578'},
       {'rnum': '6',
        'rank': '6',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20161872',
        'movieNm': '너의 이름은.',
        'openDt': '2017-01-04',
        'salesAmt': '325811500',
        'salesShare': '3.4',
        'salesInten': '31854500',
        'salesChange': '10.8',
        'salesAcc': '640998500',
        'audiCnt': '37418',
        'audiInten': '3245',
        'audiChange': '9.5',
        'audiAcc': '74181',
        'scrnCnt': '275',
        'showCnt': '342'},
       {'rnum': '7',
        'rank': '7',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20162727',
        'movieNm': '루돌프와 많이있어',
        'openDt': '2016-12-28',
        'salesAmt': '243890000',
        'salesShare': '2.6',
        'salesInten': '-23742600',
        'salesChange': '-8.9',
        'salesAcc': '926773600',
        'audiCnt': '29910',
        'audiInten': '-4074',
        'audiChange': '-12',
        'audiAcc': '119420',
        'scrnCnt': '372',
        'showCnt': '581'},
       {'rnum': '8',
        'rank': '8',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20162183',
        'movieNm': '포켓몬 더 무비 XY&Z 「볼케니온 : 기계왕국의 비밀」',
        'openDt': '2016-12-22',
        'salesAmt': '154931400',
        'salesShare': '1.6',
        'salesInten': '-31745800',
        'salesChange': '-17',
        'salesAcc': '1821568800',
        'audiCnt': '19405',
        'audiInten': '-4703',
        'audiChange': '-19.5',
        'audiAcc': '238452',
        'scrnCnt': '300',
        'showCnt': '422'},
       {'rnum': '9',
        'rank': '9',
        'rankInten': '0',
        'rankOldAndNew': 'OLD',
        'movieCd': '20152371',
        'movieNm': '당신, 거기 있어줄래요',
        'openDt': '2016-12-14',
        'salesAmt': '166222000',
        'salesShare': '1.7',
        'salesInten': '-30383700',
        'salesChange': '-15.5',
        'salesAcc': '9165307248',
        'audiCnt': '18630',
        'audiInten': '-4126',
        'audiChange': '-18.1',
        'audiAcc': '1143445',
        'scrnCnt': '261',
        'showCnt': '572'},
       {'rnum': '10',
        'rank': '10',
        'rankInten': '1',
        'rankOldAndNew': 'OLD',
        'movieCd': '20165285',
        'movieNm': '극장판 도라에몽: 신 진구의 버스 오브 재팬',
        'openDt': '2016-12-21',
        'salesAmt': '28628400',
        'salesShare': '0.3',
        'salesInten': '-7085700',
        'salesChange': '-19.8',
        'salesAcc': '482548500',
        'audiCnt': '3552',
        'audiInten': '-985',
        'audiChange': '-21.7',
        'audiAcc': '62699',
        'scrnCnt': '97',
        'showCnt': '107'}]}}



```python
#일별 데이터  : csv로 저장 함수 정의 

#mykey= '430156241533f1d058c603178cc3ca0e' #kobis에서 key 발급
#mykey='4aa9ba2ba5fd74d34df70439d3b483db'
# mykey='aec9e1bc0c849c607bac8a03d6bdb25e' #내 키 일일 조회수 초과해서 예시에 있는 키

def daily_boxoffice(start_date, end_date) :
    
    final_list = []
#     url = 'http://www.kobis.or.kr/kobisopenapi/webservice/rest/boxoffice/searchDailyBoxOfficeList.json'

    for single_date in tqdm_notebook(pd.date_range(start_date, end_date)) :
        for rep in ["","_K", "_F"] :            
#             dic={
#             'key' : keys,
#             'targetDt' : single_date.strftime('%Y%m%d'),
#             'itemPerPage' : '10', 
#             'repNationCd' : rep #한국영화 K, 외국영화 F
#             }
            
#             req = requests.get(url, params = dic)           
#             text = req.text
#             d = json.loads(text) 

            targetDt = str(single_date)[0:4]+str(single_date)[5:7]+str(single_date)[8:10]
            with open('data/'+str(targetDt)[0:4]+rep+'/'+str(targetDt)+rep+'.json', 'r', encoding="utf-8") as read_file:
                d = json.load(read_file)
            
            for item in d["boxOfficeResult"]["dailyBoxOfficeList"] :
                value_list = []
                key_list = []
                for key, value in item.items() :
                    key_list.append(key)
                    value_list.append(value)
                    
                value_list.append(single_date)
                key_list.append('CurrentDate')
                
                value_list.append(rep)
                key_list.append('Nation')
            
                final_list.append(value_list)

    return pd.DataFrame(final_list, columns=key_list)     # final_list에 담긴 내용을 df로 반환
```

```python
start_date = date(2017,1,1)
end_date = date(2017,12,31)
a = daily_boxoffice(start_date, end_date)
```


    HBox(children=(IntProgress(value=0, max=365), HTML(value='')))


    


```python
#일별 박스 오피스를 월별로 추출, 영화코드 리스트 추출 ###ok
movie_code_list_all=pd.DataFrame()
for i in tqdm_notebook(range(1)):
    start_date = my_date + relativedelta(months=i)
    end_date = start_date+ relativedelta(months=1) - datetime.timedelta(days=1)
    
    daily_boxoffice_data = daily_boxoffice(start_date, end_date)
    startdate=start_date.strftime('%Y%m%d')
    
    enddate=end_date.strftime('%Y%m%d')
    
    movie_code_list = pd.DataFrame({'movieCd' :daily_boxoffice_data.movieCd.drop_duplicates(), 'movieNm':daily_boxoffice_data.movieNm.drop_duplicates(), 'director':'','Rate' : 0})
    
    
    daily_boxoffice_data.to_csv("daliy_boxoffice_data_"+startdate+"~"+enddate+".csv", index=False)
    movie_code_list.to_csv("movie_code_list_"+startdate+"~"+enddate+".csv", index=False)
    
    movie_code_list_all = movie_code_list.append(movie_code_list_all)
    movie_code_list_all = movie_code_list_all.drop_duplicates()
    movie_code_list_all.to_csv("movie_code_list_all.csv", index=False)
```


    HBox(children=(IntProgress(value=0, max=1), HTML(value='')))



    HBox(children=(IntProgress(value=0, max=31), HTML(value='')))


    


--------------------------------------------------------------
영화 코드를 통해 영화 정보 파일 불러오기
--------------------------------------------------------------

```python
def movie_info_api(df):
    for i in range(0,len(df['movieCd'])):
        movieCd = str(df['movieCd'][i])

        if(os.path.isfile("/root/movie/movie_info/"+movieCd+".json")):
            print(movieCd+".json already exist!")

        else:
            url = 'http://www.kobis.or.kr/kobisopenapi/webservice/rest/movie/searchMovieInfo.json?key='\
                +key+'&movieCd='+movieCd    
            res = requests.get(url)
            text = res.text
            d = json.loads(text)
            print(movieCd+".json is created!")
            with open('movie_info/'+movieCd+'.json', 'w', encoding="utf-8") as make_file:
                json.dump(d, make_file, ensure_ascii=False, indent="\t")
```

```python
df = pd.read_csv('movie_code_list_all.csv')
movie_info_api(df)
```

    20161725.json already exist!
    20163183.json already exist!
    20162025.json already exist!
    20144641.json already exist!
    20167904.json already exist!
    20161872.json already exist!
    20162727.json already exist!
    20162183.json already exist!
    20152371.json already exist!
    20165285.json already exist!
    20154661.json already exist!
    20161701.json already exist!
    20161603.json already exist!
    20162545.json already exist!
    20159286.json already exist!
    20164527.json already exist!
    20153401.json already exist!
    20161763.json already exist!
    20165543.json already exist!
    19890291.json already exist!
    20150966.json already exist!
    20165925.json already exist!
    20080893.json already exist!
    20160221.json already exist!
    20163014.json already exist!
    20151181.json already exist!
    20154342.json already exist!
    20155223.json already exist!
    20167286.json already exist!
    20161084.json already exist!
    20165153.json already exist!
    20145486.json already exist!
    20165061.json already exist!
    20164485.json already exist!
    20151228.json already exist!
    20165144.json already exist!
    20101406.json already exist!
    20151229.json already exist!
    19880070.json already exist!
    19688044.json already exist!
    20110014.json already exist!
    20157631.json already exist!
    20160261.json already exist!
    20164421.json already exist!
    20168381.json already exist!
    20168324.json already exist!
    20163845.json already exist!
    20168246.json already exist!
    20167127.json already exist!
    20165443.json already exist!
    20160881.json already exist!
    20149384.json already exist!
    20155700.json already exist!
    19600018.json already exist!
    20168664.json already exist!
    20163186.json already exist!
    20010130.json already exist!
    20167324.json already exist!
    20168104.json already exist!
    20168086.json already exist!
    20168088.json already exist!
    20168087.json already exist!
    20166421.json already exist!
    20167644.json already exist!
    20168154.json already exist!
    20179481.json already exist!
    20158482.json already exist!
    20168688.json already exist!
    20167285.json already exist!
    20158799.json already exist!
    19598036.json already exist!
    20168689.json already exist!
    20165822.json already exist!
    20168611.json already exist!
    20168366.json already exist!
    19820052.json already exist!
    20166707.json already exist!
    19730023.json already exist!
    20150964.json already exist!


```python
#영화데이터  : txt 로 저장 함수 정의
def movie_data(lists) :    
    dict_list = dict()

    for movie in lists :
        with open('movie_info/'+movie+'.json', 'r', encoding="utf-8") as read_file:
            d = json.load(read_file)
        
        dict_list[movie] = d['movieInfoResult']['movieInfo'] #dict_list[movie] 가 있어야 append형식으로 됨. 없으면 마지막것만 추출
    return dict_list
```

```python
movie_info=movie_data(movie_code_list_all.movieCd) 
with open('movie_info.txt', 'w', encoding='utf-8') as outfile:   #딕셔너리를 json으로 저장
    json.dump(movie_info, outfile, ensure_ascii=False)
```

```python
#movie_info의  director를 뽑아서 movie_code_list에 넣기
movie_info_keys=list(movie_info.keys())
movie_info_keys
```




    ['20161725',
     '20163183',
     '20162025',
     '20144641',
     '20167904',
     '20161872',
     '20162727',
     '20162183',
     '20152371',
     '20165285',
     '20154661',
     '20161701',
     '20161603',
     '20162545',
     '20159286',
     '20164527',
     '20153401',
     '20161763',
     '20165543',
     '19890291',
     '20150966',
     '20165925',
     '20080893',
     '20160221',
     '20163014',
     '20151181',
     '20154342',
     '20155223',
     '20167286',
     '20161084',
     '20165153',
     '20145486',
     '20165061',
     '20164485',
     '20151228',
     '20165144',
     '20101406',
     '20151229',
     '19880070',
     '19688044',
     '20110014',
     '20157631',
     '20160261',
     '20164421',
     '20168381',
     '20168324',
     '20163845',
     '20168246',
     '20167127',
     '20165443',
     '20160881',
     '20149384',
     '20155700',
     '19600018',
     '20168664',
     '20163186',
     '20010130',
     '20167324',
     '20168104',
     '20168086',
     '20168088',
     '20168087',
     '20166421',
     '20167644',
     '20168154',
     '20179481',
     '20158482',
     '20168688',
     '20167285',
     '20158799',
     '19598036',
     '20168689',
     '20165822',
     '20168611',
     '20168366',
     '19820052',
     '20166707',
     '19730023',
     '20150964']



```python
movie_code_list_all = pd.read_csv("movie_code_list_all.csv")
for i in range(len(movie_code_list_all)):
    movie_code_list_all.iloc[i,2]=movie_info[movie_info_keys[i]]['directors'][0]['peopleNm']
```

```python
movie_code_list_all
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>movieCd</th>
      <th>movieNm</th>
      <th>director</th>
      <th>Rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>20161725</td>
      <td>마스터</td>
      <td>조의석</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>20163183</td>
      <td>로그 원: 스타워즈 스토리</td>
      <td>가렛 에드워즈</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>20162025</td>
      <td>씽</td>
      <td>가스 제닝스</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>20144641</td>
      <td>판도라</td>
      <td>박정우</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>20167904</td>
      <td>라라랜드</td>
      <td>데이미언 셔젤</td>
      <td>0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>20161872</td>
      <td>너의 이름은.</td>
      <td>신카이 마코토</td>
      <td>0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>20162727</td>
      <td>루돌프와 많이있어</td>
      <td>유야마 쿠니히코</td>
      <td>0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>20162183</td>
      <td>포켓몬 더 무비 XY&amp;Z 「볼케니온 : 기계왕국의 비밀」</td>
      <td>유야마 쿠니히코</td>
      <td>0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>20152371</td>
      <td>당신, 거기 있어줄래요</td>
      <td>홍지영</td>
      <td>0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>20165285</td>
      <td>극장판 도라에몽: 신 진구의 버스 오브 재팬</td>
      <td>야쿠와 신노스케</td>
      <td>0</td>
    </tr>
    <tr>
      <th>10</th>
      <td>20154661</td>
      <td>형</td>
      <td>권수경</td>
      <td>0</td>
    </tr>
    <tr>
      <th>11</th>
      <td>20161701</td>
      <td>위켄즈</td>
      <td>이동하</td>
      <td>0</td>
    </tr>
    <tr>
      <th>12</th>
      <td>20161603</td>
      <td>순종</td>
      <td>김동민</td>
      <td>0</td>
    </tr>
    <tr>
      <th>13</th>
      <td>20162545</td>
      <td>무현, 두 도시 이야기</td>
      <td>전인환</td>
      <td>0</td>
    </tr>
    <tr>
      <th>14</th>
      <td>20159286</td>
      <td>연애담</td>
      <td>이현주</td>
      <td>0</td>
    </tr>
    <tr>
      <th>15</th>
      <td>20164527</td>
      <td>부릉! 부릉! 브루미즈: 스피더의 모험 일기</td>
      <td>이영준</td>
      <td>0</td>
    </tr>
    <tr>
      <th>16</th>
      <td>20153401</td>
      <td>파파좀비</td>
      <td>고현창</td>
      <td>0</td>
    </tr>
    <tr>
      <th>17</th>
      <td>20161763</td>
      <td>나, 다니엘 블레이크</td>
      <td>켄 로치</td>
      <td>0</td>
    </tr>
    <tr>
      <th>18</th>
      <td>20165543</td>
      <td>하이큐!! 승자와 패자</td>
      <td>미츠나카 스스무</td>
      <td>0</td>
    </tr>
    <tr>
      <th>19</th>
      <td>19890291</td>
      <td>해리가 샐리를 만났을 때</td>
      <td>롭 라이너</td>
      <td>0</td>
    </tr>
    <tr>
      <th>20</th>
      <td>20150966</td>
      <td>사랑하기 때문에</td>
      <td>주지홍</td>
      <td>0</td>
    </tr>
    <tr>
      <th>21</th>
      <td>20165925</td>
      <td>음란 과외 - 무삭제판</td>
      <td>최우성</td>
      <td>0</td>
    </tr>
    <tr>
      <th>22</th>
      <td>20080893</td>
      <td>렌의 애가</td>
      <td>김기영</td>
      <td>0</td>
    </tr>
    <tr>
      <th>23</th>
      <td>20160221</td>
      <td>에곤 쉴레: 욕망이 그린 그림</td>
      <td>디에터 버너</td>
      <td>0</td>
    </tr>
    <tr>
      <th>24</th>
      <td>20163014</td>
      <td>7년-그들이 없는 언론</td>
      <td>김진혁</td>
      <td>0</td>
    </tr>
    <tr>
      <th>25</th>
      <td>20151181</td>
      <td>여교사</td>
      <td>김태용</td>
      <td>0</td>
    </tr>
    <tr>
      <th>26</th>
      <td>20154342</td>
      <td>뚜르: 내 생애 최고의 49일</td>
      <td>전일우</td>
      <td>0</td>
    </tr>
    <tr>
      <th>27</th>
      <td>20155223</td>
      <td>목숨 건 연애</td>
      <td>송민규</td>
      <td>0</td>
    </tr>
    <tr>
      <th>28</th>
      <td>20167286</td>
      <td>형의 여자</td>
      <td>모리오카 토시유키</td>
      <td>0</td>
    </tr>
    <tr>
      <th>29</th>
      <td>20161084</td>
      <td>패신저스</td>
      <td>모튼 틸덤</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>49</th>
      <td>20165443</td>
      <td>모아나</td>
      <td>론 클레멘츠</td>
      <td>0</td>
    </tr>
    <tr>
      <th>50</th>
      <td>20160881</td>
      <td>문영</td>
      <td>김소연</td>
      <td>0</td>
    </tr>
    <tr>
      <th>51</th>
      <td>20149384</td>
      <td>청일전쟁과 여걸 민비</td>
      <td>임원식</td>
      <td>0</td>
    </tr>
    <tr>
      <th>52</th>
      <td>20155700</td>
      <td>왕자 호동</td>
      <td>한형모</td>
      <td>0</td>
    </tr>
    <tr>
      <th>53</th>
      <td>19600018</td>
      <td>하녀</td>
      <td>김기영</td>
      <td>0</td>
    </tr>
    <tr>
      <th>54</th>
      <td>20168664</td>
      <td>반지의 제왕 : 두개의 탑 (확장판)</td>
      <td>피터 잭슨</td>
      <td>0</td>
    </tr>
    <tr>
      <th>55</th>
      <td>20163186</td>
      <td>단지 세상의 끝</td>
      <td>자비에 돌란</td>
      <td>0</td>
    </tr>
    <tr>
      <th>56</th>
      <td>20010130</td>
      <td>빌리 엘리어트</td>
      <td>스티븐 달드리</td>
      <td>0</td>
    </tr>
    <tr>
      <th>57</th>
      <td>20167324</td>
      <td>라이언</td>
      <td>가스 데이비스</td>
      <td>0</td>
    </tr>
    <tr>
      <th>58</th>
      <td>20168104</td>
      <td>2017 한국영화아카데미 33기 졸업영화제 - B</td>
      <td>배경헌</td>
      <td>0</td>
    </tr>
    <tr>
      <th>59</th>
      <td>20168086</td>
      <td>2017 한국영화아카데미 33기 졸업영화제 - A</td>
      <td>곽승민</td>
      <td>0</td>
    </tr>
    <tr>
      <th>60</th>
      <td>20168088</td>
      <td>2017 한국영화아카데미 33기 졸업영화제 - D</td>
      <td>전희욱</td>
      <td>0</td>
    </tr>
    <tr>
      <th>61</th>
      <td>20168087</td>
      <td>2017 한국영화아카데미 33기 졸업영화제 - C</td>
      <td>한가람</td>
      <td>0</td>
    </tr>
    <tr>
      <th>62</th>
      <td>20166421</td>
      <td>재심</td>
      <td>김태윤</td>
      <td>0</td>
    </tr>
    <tr>
      <th>63</th>
      <td>20167644</td>
      <td>발레리나</td>
      <td>에릭 섬머</td>
      <td>0</td>
    </tr>
    <tr>
      <th>64</th>
      <td>20168154</td>
      <td>딥워터 호라이즌</td>
      <td>피터 버그</td>
      <td>0</td>
    </tr>
    <tr>
      <th>65</th>
      <td>20179481</td>
      <td>사랑받지 못한 여자</td>
      <td>노진수</td>
      <td>0</td>
    </tr>
    <tr>
      <th>66</th>
      <td>20158482</td>
      <td>동주</td>
      <td>이준익</td>
      <td>0</td>
    </tr>
    <tr>
      <th>67</th>
      <td>20168688</td>
      <td>레지던트 이블: 파멸의 날</td>
      <td>폴 W.S. 앤더슨</td>
      <td>0</td>
    </tr>
    <tr>
      <th>68</th>
      <td>20167285</td>
      <td>짱구는 못말려 극장판: 폭풍수면! 꿈꾸는 세계 대돌격</td>
      <td>타카하시 와타루</td>
      <td>0</td>
    </tr>
    <tr>
      <th>69</th>
      <td>20158799</td>
      <td>눈길</td>
      <td>이나정</td>
      <td>0</td>
    </tr>
    <tr>
      <th>70</th>
      <td>19598036</td>
      <td>여사장</td>
      <td>한형모</td>
      <td>0</td>
    </tr>
    <tr>
      <th>71</th>
      <td>20168689</td>
      <td>반지의 제왕 : 왕의 귀환 (확장판)</td>
      <td>피터 잭슨</td>
      <td>0</td>
    </tr>
    <tr>
      <th>72</th>
      <td>20165822</td>
      <td>매기스 플랜</td>
      <td>레베카 밀러</td>
      <td>0</td>
    </tr>
    <tr>
      <th>73</th>
      <td>20168611</td>
      <td>키코리키: 황금모자의 비밀</td>
      <td>데니스 체르노프</td>
      <td>0</td>
    </tr>
    <tr>
      <th>74</th>
      <td>20168366</td>
      <td>바다 탐험대 옥토넛 시즌4: 바다 괴물 대소동</td>
      <td>다라 오코넬</td>
      <td>0</td>
    </tr>
    <tr>
      <th>75</th>
      <td>19820052</td>
      <td>애인</td>
      <td>박호태</td>
      <td>0</td>
    </tr>
    <tr>
      <th>76</th>
      <td>20166707</td>
      <td>재키</td>
      <td>파블로 라라인</td>
      <td>0</td>
    </tr>
    <tr>
      <th>77</th>
      <td>19730023</td>
      <td>흑권</td>
      <td>황풍</td>
      <td>0</td>
    </tr>
    <tr>
      <th>78</th>
      <td>20150964</td>
      <td>조작된 도시</td>
      <td>박광현</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>79 rows × 4 columns</p>
</div>



```python
############### 네이버 api로 별점 추출, def 이용_1
```

```python
from bs4 import BeautifulSoup
import urllib.request
from urllib.parse import quote
import json
import re
import requests

naver_client_id = "nA8Iwm4HJ6EM2W1dueU9"
naver_client_secret = "HaEPQCPbyQ"

def cleanhtml(raw_html):
    cleanr = re.compile('<.*?>')
    cleantext = re.sub(cleanr, '', raw_html)
    return cleantext
def searchByTitle(title): #네이버 api
    myurl = 'https://openapi.naver.com/v1/search/movie.json?display=100&query=' + quote(title)
    request = urllib.request.Request(myurl)
    request.add_header("X-Naver-Client-Id",naver_client_id)
    request.add_header("X-Naver-Client-Secret",naver_client_secret)
    response = urllib.request.urlopen(request)
    rescode = response.getcode()
    if(rescode==200):
        response_body = response.read()
        d = json.loads(response_body.decode('utf-8'))
        if (len(d['items']) > 0):
            return d['items']
        else:
            return None 
    else:
        print("Error Code:" + rescode)
```

```python
#requests data 불러오기
def findItemByInput(items):
    
    n=len(items)
    #print('n = ',n)
    for index, item in enumerate(items):
        navertitle = cleanhtml(item['title'])
        naversubtitle = cleanhtml(item['subtitle'])
 #       naverpubdate = cleanhtml(item['pubDate'])
 #       naveractor = cleanhtml(item['actor'])
        naverlink = cleanhtml(item['link']) # 있어야함
        naverdirecter=cleanhtml(item['director'])
        naveruserScore = cleanhtml(item['userRating'])
 
        navertitle1 = navertitle.replace(" ","")
        navertitle1 = navertitle1.replace("-", ",")
        navertitle1 = navertitle1.replace(":", ",")
 
        spScore = getSpecialScore(naverlink)  #기자 평론가 평점을 얻어 옵니다
        
        naverid = re.split("code=", naverlink)[1]  #네이버가 다루는 영화 고유 ID를 얻어 옵니다
   #     print('naveruserScore',naveruserScore)
#         print(naveruserScore)
        a = pd insert(index,naveruserScore)
      #  print(naverid, navertitle,naveruserScore, spScore)
        print(index, navertitle, naversubtitle, naveruserScore, spScore)
#         return a
```

```python

```

```python
def getInfoFromNaver(searchTitle):
    items = searchByTitle(searchTitle)
 
    if (items != None):
        findItemByInput(items)
    else:
        print("No result") 
```

```python
def get_soup(url):
    source_code = requests.get(url)
    plain_text = source_code.text
    soup = BeautifulSoup(plain_text, 'lxml')
    return soup
 
#기자 평론가 평점을 얻어 옵니다
def getSpecialScore(URL):
    soup = get_soup(URL)
    scorearea = soup.find_all('div', "spc_score_area")
    newsoup = BeautifulSoup(str(scorearea), 'lxml')
    score = newsoup.find_all('em')
    if (score and len(score) > 5):
        scoreis = score[1].text + score[2].text + score[3].text + score[4].text
        return float(scoreis)
    else:
        return 0.0
```

```python
i = movie_code_list_all['movieNm'][1]
findItemByInput(i)
```


    ---------------------------------------------------------------------------

    TypeError                                 Traceback (most recent call last)

    <ipython-input-113-8c9359a2a2bc> in <module>
          1 i = movie_code_list_all['movieNm'][1]
    ----> 2 findItemByInput(i)
    

    <ipython-input-110-61a3fe4ba632> in findItemByInput(items)
          5     #print('n = ',n)
          6     for index, item in enumerate(items):
    ----> 7         navertitle = cleanhtml(item['title'])
          8  #       naversubtitle = cleanhtml(item['subtitle'])
          9  #       naverpubdate = cleanhtml(item['pubDate'])


    TypeError: string indices must be integers


```python
name=movie_code_list_all.iloc[r,3]
name
```




    0



```python

b=[]
# for r in tqdm_notebook(range(10)):
#     print('r = ',r)
    
name=movie_code_list_all['movieNm'][6]
print('name = ',name)  
    
#     a = getInfoFromNaver(name)   #이 값을 변수에 넣을 수가 없음 ㅠㅠ 대입이 안됨
    
items = searchByTitle(name)
#     for i in range(len(items)):
if (items != None):
    b.append(findItemByInput(items))
#     findItemByInput(items)
else:
    print("No result")

# movie_code_list_all
```

    name =  루돌프와 많이있어
    0 루돌프와 많이있어 Rudolf The Black Cat 8.79 6.38


```python
b
```




    [None]



```python
for r in tqdm_notebook(range(10)):
    print('r = ',r)
    
    name=movie_code_list_all['movieNm'][r]
    print('name = ',name)  
    
    getInfoFromNaver(name)    #이 값을 변수에 넣을 수가 없음 ㅠㅠ 대입이 안됨
    


```


    HBox(children=(IntProgress(value=0, max=10), HTML(value='')))


    r =  0
    name =  마스터
    2.60
    8.50
    0.00
    0.00
    0.00
    8.77
    10.00
    0.00
    0.00
    0.00
    8.10
    7.54
    7.73
    4.00
    0.00
    0.00
    0.00
    0.00
    7.24
    8.38
    8.33
    8.50
    7.00
    0.00
    0.00
    0.00
    0.00
    8.51
    8.67
    6.00
    3.57
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    6.00
    0.00
    8.03
    7.84
    9.67
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    7.91
    0.00
    0.00
    2.00
    0.00
    7.13
    8.75
    4.13
    0.00
    0.00
    0.00
    0.00
    8.00
    0.00
    0.00
    0.00
    10.00
    0.00
    9.38
    2.59
    8.00
    0.00
    0.00
    0.00
    0.00
    4.33
    9.00
    0.00
    7.33
    9.21
    0.00
    0.00
    0.00
    5.50
    0.00
    6.67
    2.75
    9.75
    0.00
    8.45
    6.36
    0.00
    4.40
    2.29
    8.00
    3.00
    0.00
    3.88
    9.00
    7.19
    r =  1
    name =  로그 원: 스타워즈 스토리
    8.44
    r =  2
    name =  씽
    0.00
    7.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    8.96
    5.57
    9.00
    0.00
    0.00
    0.00
    0.00
    6.20
    8.12
    7.37
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    10.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    7.89
    10.00
    0.00
    0.00
    0.00
    0.00
    7.75
    0.00
    9.60
    5.81
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    0.00
    8.31
    0.00
    0.00
    6.88
    2.60
    7.00
    0.00
    3.94
    1.00
    0.00
    5.76
    7.89
    7.00
    0.00
    0.00
    0.00
    6.15
    8.52
    0.00
    6.28
    6.55
    6.14
    4.25
    7.06
    7.12
    8.90
    0.00
    0.00
    8.95
    r =  3
    name =  판도라
    8.31
    10.00
    10.00
    10.00
    10.00
    5.50
    0.00
    7.75
    0.00
    0.00
    0.00
    0.00
    0.00
    6.03
    0.00
    0.00
    0.00
    1.67
    10.00
    0.00
    8.50
    7.80
    r =  4
    name =  라라랜드
    8.59
    0.00
    0.00
    r =  5
    name =  너의 이름은.
    8.75
    0.00
    8.00
    0.00
    r =  6
    name =  루돌프와 많이있어
    8.79
    r =  7
    name =  포켓몬 더 무비 XY&Z 「볼케니온 : 기계왕국의 비밀」
    8.75
    r =  8
    name =  당신, 거기 있어줄래요
    8.68
    r =  9
    name =  극장판 도라에몽: 신 진구의 버스 오브 재팬
    9.04
    


```python
############### 네이버 api로 별점 추출, def 이용_2
import os
import sys
import urllib.request

client_id = "YO4i1JrH8SJibQryNA8j"
client_secret = "gYKhYt564S"

with open('movie_info.txt', 'w', encoding='utf-8') as outfile:   
    json.dump(movie_info, outfile, ensure_ascii=False)

from IPython.display import clear_output

def naver_starscore():
    for i in tqdm_notebook(range(len(movie_code_list_all))) : 
        url = 'https://openapi.naver.com/v1/search/movie.json'
        dic = {
            'query' : movie_code_list_all.iloc[i, 3],
            'display' : 10
        }

        headers = {
            'X-Naver-Client-Id' : 'API Client ID',
            'X-Naver-Client-Secret' : 'API Client Secret'
        }
        
        request = requests.get(url, headers=headers, dic=payload)        
        response = urllib.request.urlopen(request)
        rescode = response.getcode()
        
        if(rescode==200):
            response_body = response.read()
            js_naver = json.loads(response_body)
            print(l, 'th = request success')
            print('js_naver = \n', js_naver)

            if js_naver['total']==1: #영화명 1개, 별점 추출                
                if movie_code_list_all.iloc[l,3].replace(' ', '') == js_naver['items'][0]['title'][3:-4].replace(' ', ''):
                    movie_code_list_all.iloc[l,0] = js_naver['items'][0]['userRating']
                    print(' 영화명1개, 일치,  okokokokkok')
                else:                
                    print(' 영화명1개, 불일치')

            else:  #영화명 여러개 
             #   print('js_naver[items].count(title) = ',js_naver['items'].count('title'))
                for j in range(1,js_naver['items'].count('title')):
                 #   print('j = ', j)
                    for k in range(80):
                 #       print('k = ',k)
              #          print('js_naver director =',js_naver['items'][j]['director'][:3],'movie_code_list_all.iloc[k,1] = ',movie_code_list_all.iloc[k,1])
                        if js_naver['items'][j]['director'][:3] == movie_code_list_all.iloc[k,1]:                        
                            movie_code_list_all.iloc[l,0] = js_naver['items'][0]['userRating']
                #            print('영화여러개, 감독 일치, okokokok')
                        else:
                            movie_code_list_all.iloc[l,0] = 0
                   #         print('영화여러개, 감독불일치, 별점 0')
        else:
            print("Error Code:" + rescode)
```

```python
movie_code_list_all
```

```python
############### 네이버 api로 별점 추출, display = 100 으로 수정중
import os
import sys
import urllib.request

client_id = "YO4i1JrH8SJibQryNA8j"
client_secret = "gYKhYt564S"

with open('movie_info.txt', 'w', encoding='utf-8') as outfile:   
    json.dump(movie_info, outfile, ensure_ascii=False)

for i in tqdm_notebook(range(len(movie_code_list_all))) :  
    url = 'https://openapi.naver.com/v1/search/movie.json'
    dic = {
        'query' : movie_code_list_all.iloc[i, 3],
         'display' : 100
    }
    headers = {
         'X-Naver-Client-Id' : 'API Client ID',
          'X-Naver-Client-Secret' : 'API Client Secret'
       }    
    req = requests.get(url, headers=headers, params=dic)
    response = urllib.request.urlopen(request)
    rescode = response.getcode()        
    
    if(rescode==200):
        response_body = response.read()
        js_naver = json.loads(response_body)
        print(l, 'th = request success')
        print('js_naver = \n', js_naver)
        
        if js_naver['total']==1: #영화명 1개, 별점 추출                
            if movie_code_list_all.iloc[l,3].replace(' ', '') == js_naver['items'][0]['title'][3:-4].replace(' ', ''):
                movie_code_list_all.iloc[l,0] = js_naver['items'][0]['userRating']
                print(' 영화명1개, 일치,  okokokokkok')
            else:                
                print(' 영화명1개, 불일치')
                
        else:  #영화명 여러개 
            print('js_naver[items].count(title) = ',js_naver['items'].count('title'))
            for j in range(1,js_naver['items'].count('title')):
                print('j = ', j)
                for k in range(80):
                    print('k = ',k)
                    print('js_naver director =',js_naver['items'][j]['director'][:3],'movie_code_list_all.iloc[k,1] = ',movie_code_list_all.iloc[k,1])
                    if js_naver['items'][j]['director'][:3] == movie_code_list_all.iloc[k,1]:                        
                        movie_code_list_all.iloc[l,0] = js_naver['items'][0]['userRating']
            #            print('영화여러개, 감독 일치, okokokok')
                    else:
                        movie_code_list_all.iloc[l,0] = 0
               #         print('영화여러개, 감독불일치, 별점 0')
    else:
        print("Error Code:" + rescode)
```

```python
movie_code_list_all
```

```python
############### 네이버 api로 별점 추출, display=10
import os
import sys
import urllib.request

client_id = "YO4i1JrH8SJibQryNA8j"
client_secret = "gYKhYt564S"

with open('movie_info.txt', 'w', encoding='utf-8') as outfile:   
    json.dump(movie_info, outfile, ensure_ascii=False)

for l in tqdm_notebook(range(len(movie_code_list_all))):
    m=movie_code_list_all.iloc[l,3] #영화명이 iloc[l,3]
    encText = urllib.parse.quote(m)
    url = "https://openapi.naver.com/v1/search/movie.json?query=" + encText # json 결과
    request = urllib.request.Request(url)
    request.add_header("X-Naver-Client-Id",client_id)
    request.add_header("X-Naver-Client-Secret",client_secret)
    response = urllib.request.urlopen(request)
    rescode = response.getcode()
    
    if(rescode==200):
        response_body = response.read()
        js_naver = json.loads(response_body)
        print(l, 'th = request success')
        print('js_naver = \n', js_naver)
        
        if js_naver['total']==1: #영화명 1개, 별점 추출                
            if movie_code_list_all.iloc[l,3].replace(' ', '') == js_naver['items'][0]['title'][3:-4].replace(' ', ''):
                movie_code_list_all.iloc[l,0] = js_naver['items'][0]['userRating']
                print(' 영화명1개, 일치,  okokokokkok')
            else:                
                print(' 영화명1개, 불일치')
                
        else:  #영화명 여러개 
            print('js_naver[items].count(title) = ',js_naver['items'].count('title'))
            for j in range(1,js_naver['items'].count('title')):
                print('j = ', j)
                for k in range(80):
                    print('k = ',k)
                    print('js_naver director =',js_naver['items'][j]['director'][:3],'movie_code_list_all.iloc[k,1] = ',movie_code_list_all.iloc[k,1])
                    if js_naver['items'][j]['director'][:3] == movie_code_list_all.iloc[k,1]:                        
                        movie_code_list_all.iloc[l,0] = js_naver['items'][0]['userRating']
            #            print('영화여러개, 감독 일치, okokokok')
                    else:
                        movie_code_list_all.iloc[l,0] = 0
               #         print('영화여러개, 감독불일치, 별점 0')
    else:
        print("Error Code:" + rescode)
```

```python
movie_code_list_all
```

```python
movie_code_list_all.to_csv("movie_code_list_all.csv", index=False)
```
